apiVersion: monitoring.appscode.com/v1alpha1
kind: Runbook
metadata:
  name: kubedb-mongodb-ops-request-failed
spec:
  variables:
    - name: k8sKind
      valueFrom:
        alertPathRef:
          path: .labels.k8s_kind
    - name: app
      valueFrom:
        alertPathRef:
          path: .labels.app
    - name: appNamespace
      valueFrom:
        alertPathRef:
          path: .labels.app_namespace
    - name: k8sGroup
      valueFrom:
        alertPathRef:
          path: .labels.k8s_group
    - name: startsAt
      valueFrom:
        alertPathRef:
          path: .startsAt
  diagnosticChecks:
    - type: CheckStatusAnomalies
      args:
        resourceGroup: ${k8sGroup}
        resourceKind: ${k8sKind}
        resourceName: ${app}
        resourceNamespace: ${appNamespace}
        anomalyRules:
          - path: status.conditions[?status == 'False']
            matchCriteria:
              operator: NotEmpty
    - type: CheckEvents
      args:
        alertStartTime: ${startsAt}
        lookbackDuration: 5m
        maxEventLimit: 10
        resourceGroup: ${k8sGroup}
        resourceKind: ${k8sKind}
        resourceName: ${app}
        resourceNamespace: ${appNamespace}
    - type: CheckLogs
      args:
        alertStartTime: ${startsAt}
        lookbackDuration: 5m
        tailLines: 50
        labelSelector: app.kubernetes.io/name=kubedb-ops-manager
        containers: operator
